<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ğŸŒ¿ Dream OS v4.4.1 | SIF Al Fikri</title>
  
  <meta name="theme-color" content="#4CAF50" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="description" content="System Administrasi SIF Al Fikri - The Power Soul of Shalawat" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg-main: #F8FCF6;
      --bg-card: #EAF7ED;
      --accent: #4CAF50;
      --accent-hover: #45A049;
      --text-dark: #2E7D32;
      --border-soft: #C8E6C9;
      --shadow-soft: rgba(0,0,0,0.05);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-main);
      color: var(--text-dark);
      line-height: 1.6;
      padding: 16px;
      min-height: 100vh;
      font-size: 16px;
    }

    .container { max-width: 800px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }

    .header-gradient {
      background: linear-gradient(135deg, #EAF7ED 0%, #F8FCF6 100%);
      padding: 24px 20px;
      border-radius: 20px;
      text-align: center;
      border: 1px solid var(--border-soft);
      box-shadow: 0 4px 12px var(--shadow-soft);
    }

    .arabic-large { font-size: 1.5rem; color: var(--text-dark); direction: rtl; margin: 4px 0; font-weight: bold; opacity: 0.8; }
    .title-main { font-size: 1.8rem; font-weight: 700; margin: 8px 0; }
    .subtitle { color: #666; font-size: 0.9rem; }

    .badge-container { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin-top: 15px; }
    .badge { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; background: white; border: 1px solid var(--border-soft); }
    .badge.online { color: #4CAF50; }

    .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
    .feature-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 16px 10px;
      box-shadow: 0 3px 10px var(--shadow-soft);
      border: 1px solid var(--border-soft);
      cursor: pointer;
      text-align: center;
      transition: 0.2s;
    }
    .feature-card:hover { transform: translateY(-2px); background: #fff; }
    .feature-icon { font-size: 1.8rem; margin-bottom: 8px; }
    .feature-title { font-size: 0.85rem; font-weight: 600; }

    .card { background: white; border-radius: 18px; padding: 20px; border: 1px solid var(--border-soft); box-shadow: 0 4px 12px var(--shadow-soft); }
    .form-group { margin-bottom: 15px; }
    .form-label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; }
    .form-input, .form-select, .form-textarea {
      width: 100%; padding: 12px; border: 1.5px solid var(--border-soft); border-radius: 10px; font-size: 1rem;
    }

    .btn {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      padding: 14px; border-radius: 12px; font-weight: 600; border: none; cursor: pointer; transition: 0.3s; width: 100%;
      background: var(--accent); color: white;
    }
    .btn-secondary { background: #f0f0f0; color: #444; }

    .hidden { display: none !important; }
    #toast {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: #333; color: white; padding: 10px 20px; border-radius: 30px; z-index: 9999; display: none; font-size: 0.9rem;
    }
    .img-preview { width: 100%; border-radius: 10px; margin-top: 10px; display: none; border: 1px solid #ddd; }
    
    .footer { text-align: center; padding: 20px; font-size: 0.8rem; color: #555; line-height: 1.5; }

    /* Calendar Mini */
    .calendar-mini { 
      margin: 15px 0; padding: 10px; background: white; border-radius: 10px; 
      border: 1px solid var(--border-soft);
    }
    .calendar-days { display: flex; gap: 5px; }
    .calendar-day { 
      flex: 1; text-align: center; padding: 8px; background: #EAF7ED; border-radius: 6px;
      font-size: 0.9rem; cursor: pointer;
    }
    .calendar-day.active { background: var(--accent); color: white; }
  </style>
</head>
<body>
  <div id="toast"></div>

  <div class="container" id="main-container">
    <div class="header-gradient">
      <div class="arabic-large">Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙÙ‘Ù°Ù‡Ù Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù</div>
      <h1 class="title-main">ğŸŒ¿ Dream OS v4.4.1</h1>
      <div class="subtitle">SIF Al Fikri â€¢ The Power Soul of Shalawat</div>
      <div class="badge-container">
        <div id="sync-status" class="badge online">ğŸŸ¢ CLOUD ACTIVE</div>
        <div class="badge">ğŸ“¡ Hybrid Cloud</div>
      </div>
      
      <!-- Calendar Mini -->
      <div id="mini-calendar" class="calendar-mini">
        <div style="font-weight:bold; margin-bottom:8px; text-align:center;">ğŸ“… 7 Hari Ke Depan</div>
        <div class="calendar-days" id="calendar-days"></div>
      </div>
    </div>

    <div id="menu-grid" class="feature-grid">
      <div class="feature-card" onclick="showBookingForm()">
        <div class="feature-icon">ğŸ“…</div>
        <div class="feature-title">Booking (19 Sarana)</div>
      </div>
      <div class="feature-card" onclick="showK3Form()">
        <div class="feature-icon">âš ï¸</div>
        <div class="feature-title">Laporan K3 + Kamera</div>
      </div>
      <div class="feature-card" onclick="showAdminPanel()">
        <div class="feature-icon">ğŸ”</div>
        <div class="feature-title">Admin Dashboard</div>
      </div>
      <div class="feature-card" onclick="backupData()">
        <div class="feature-icon">ğŸ’¾</div>
        <div class="feature-title">Backup Data</div>
      </div>
    </div>

    <div id="form-container" class="hidden"></div>

    <div class="footer">
      ğŸŒ¿ Dream Team â€“ The Power Soul of Shalawat<br>
      â€œØ±ÙØ¨ÙÙ‘ Ø§Ø´Ù’Ø±ÙØ­Ù’ Ù„ÙÙŠ ØµÙØ¯Ù’Ø±ÙÙŠ ÙˆÙÙŠÙØ³ÙÙ‘Ø±Ù’ Ù„ÙÙŠ Ø£ÙÙ…Ù’Ø±ÙÙŠâ€<br>
      Â© 2025 SIF Al Fikri â€¢ ğŸ‡®ğŸ‡©ğŸ‡µğŸ‡¸ â€¢ v4.4.1
    </div>
  </div>

  <script>
    // ========== CONFIGURASI ==========
    const WA_PAK_ERWIN = "628886183954";
    const SB_URL = "https://mugrsslvjaisdcexbybg.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11Z3Jzc2x2amFpc2RjZXhieWJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0MTMxMjAsImV4cCI6MjA4MTk4OTEyMH0.l2IszYilO0XgG7ut3HYAx6wCChsvJBj6FFlizngVoek";

    let _supabase = null;
    try {
      _supabase = supabase.createClient(SB_URL, SB_KEY);
    } catch (e) {
      console.warn("Supabase offline");
      document.getElementById('sync-status').innerText = "ğŸ”´ OFFLINE MODE";
    }

    // ========== UTILS ==========
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.innerText = msg;
      t.style.display = 'block';
      setTimeout(() => t.style.display = 'none', 3000);
    }

    function formatDate(dateStr) {
      const d = new Date(dateStr);
      return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
    }

    function showMainMenu() {
      document.getElementById('menu-grid').classList.remove('hidden');
      document.getElementById('form-container').classList.add('hidden');
    }

    // ========== INITIALIZE CALENDAR ==========
    function renderMiniCalendar() {
      const container = document.getElementById('calendar-days');
      if (!container) return;
      
      const today = new Date();
      container.innerHTML = '';
      
      for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        const dayName = date.toLocaleDateString('id-ID', { weekday: 'short' });
        const dayNum = date.getDate();
        
        const dayEl = document.createElement('div');
        dayEl.className = `calendar-day ${i === 0 ? 'active' : ''}`;
        dayEl.innerHTML = `
          <div style="font-size:0.7rem;">${dayName}</div>
          <div style="font-weight:bold; font-size:0.9rem;">${dayNum}</div>
        `;
        dayEl.onclick = () => showDateBookings(date);
        container.appendChild(dayEl);
      }
    }

    function showDateBookings(date) {
      const dateStr = date.toISOString().split('T')[0];
      const bookings = JSON.parse(localStorage.getItem('dream_bookings') || '[]');
      const dayBookings = bookings.filter(b => b.tanggal === dateStr);
      
      let msg = `ğŸ“… Booking ${formatDate(dateStr)}\n\n`;
      if (dayBookings.length === 0) {
        msg += "Tidak ada booking untuk hari ini.";
      } else {
        dayBookings.forEach((b, i) => {
          msg += `${i+1}. ${b.sarana}\n   ğŸ‘¤ ${b.nama} (${b.divisi})\n   â° ${b.waktu_mulai}-${b.waktu_selesai}\n\n`;
        });
      }
      alert(msg);
    }

    // ========== BOOKING ==========
    function showBookingForm() {
      const html = `
        <div class="card">
          <h2 style="margin-bottom:15px">ğŸ“… Booking 19 Sarana</h2>
          <form id="bookingForm">
            <div class="form-group">
              <label class="form-label">Nama Lengkap *</label>
              <input type="text" id="nama" class="form-input" required>
            </div>
            <div class="form-group">
              <label class="form-label">Divisi *</label>
              <select id="divisi" class="form-select" required>
                <option value="">-- Pilih Divisi --</option>
                <option value="SD">SD</option>
                <option value="SMP">SMP</option>
                <option value="SMA">SMA</option>
                <option value="UMUM">UMUM</option>
                <option value="OSIS">OSIS</option>
                <option value="GURU">GURU</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">WhatsApp (Opsional)</label>
              <input type="text" id="whatsapp" class="form-input" placeholder="628xx">
            </div>
            <div class="form-group">
              <label class="form-label">Sarana *</label>
              <select id="sarana" class="form-select" required>
                <option value="">-- Pilih Sarana --</option>
                <optgroup label="ğŸ¢ Aula & Serbaguna">
                  <option value="Aula SMP - sound, lighting, ac, projector (include)">Aula SMP (sound, lighting, ac, projector)</option>
                  <option value="Aula SMA - sound, projector (include)">Aula SMA (sound, projector)</option>
                  <option value="Saung Besar - sound (include)">Saung Besar (sound)</option>
                  <option value="Saung Kecil">Saung Kecil</option>
                  <option value="Serbaguna - sound (include)">Serbaguna (sound)</option>
                </optgroup>
                <optgroup label="ğŸ’» Lab Komputer">
                  <option value="Labkom SD">Labkom SD</option>
                  <option value="Labkom SMP">Labkom SMP</option>
                  <option value="Labkom SMA">Labkom SMA</option>
                </optgroup>
                <optgroup label="âš½ Lapangan Olahraga">
                  <option value="Lapangan Basket">Lapangan Basket</option>
                  <option value="Lapangan Futsal">Lapangan Futsal</option>
                  <option value="Lapangan Voli">Lapangan Voli</option>
                  <option value="Lapangan Depan Masjid">Lapangan Depan Masjid</option>
                </optgroup>
                <optgroup label="ğŸ“š Perpustakaan">
                  <option value="Perpustakaan SD">Perpustakaan SD</option>
                  <option value="Perpustakaan SMP">Perpustakaan SMP</option>
                  <option value="Perpustakaan SMA">Perpustakaan SMA</option>
                </optgroup>
                <optgroup label="ğŸ•Œ Ruang Khusus">
                  <option value="Masjid Baitul Hikmah">Masjid Baitul Hikmah</option>
                  <option value="Kantin SMP">Kantin SMP</option>
                  <option value="Kantin SMA">Kantin SMA</option>
                  <option value="Ruang Musik">Ruang Musik</option>
                </optgroup>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Tanggal *</label>
              <input type="date" id="tanggal" class="form-input" required>
            </div>
            <div class="form-group" style="display:flex; gap:10px">
              <div style="flex:1">
                <label class="form-label">Mulai *</label>
                <input type="time" id="waktuMulai" class="form-input" value="08:00" required>
              </div>
              <div style="flex:1">
                <label class="form-label">Selesai *</label>
                <input type="time" id="waktuSelesai" class="form-input" value="10:00" required>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Keterangan *</label>
              <textarea id="keterangan" class="form-textarea" rows="3" placeholder="Kegiatan apa yang akan dilakukan..." required></textarea>
            </div>
            <button type="submit" class="btn">ğŸ“± Kirim ke WhatsApp & Simpan</button>
            <button type="button" class="btn btn-secondary" onclick="showMainMenu()">â† Kembali</button>
          </form>
        </div>
      `;
      document.getElementById('form-container').innerHTML = html;
      document.getElementById('menu-grid').classList.add('hidden');
      document.getElementById('form-container').classList.remove('hidden');
      
      // Set tanggal minimal hari ini
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('tanggal').min = today;
      document.getElementById('tanggal').value = today;
      
      // Auto-focus ke nama
      setTimeout(() => document.getElementById('nama').focus(), 100);
      
      document.getElementById('bookingForm').onsubmit = submitBooking;
    }

    async function submitBooking(e) {
      e.preventDefault();
      
      const data = {
        nama: document.getElementById('nama').value.trim(),
        divisi: document.getElementById('divisi').value,
        whatsapp: document.getElementById('whatsapp').value.trim(),
        sarana: document.getElementById('sarana').value,
        tanggal: document.getElementById('tanggal').value,
        waktu_mulai: document.getElementById('waktuMulai').value,
        waktu_selesai: document.getElementById('waktuSelesai').value,
        keterangan: document.getElementById('keterangan').value.trim()
      };

      // ===== VALIDASI JUM'AT =====
      const selectedDate = new Date(data.tanggal);
      const isFriday = selectedDate.getDay() === 5; // 0=Minggu, 5=Jumat
      
      if (isFriday) {
        // Validasi sarana
        if (data.sarana.includes("Aula SMP") || data.sarana.includes("Serbaguna")) {
          alert("âŒ Aula SMP & Serbaguna TIDAK TERSEDIA hari Jum'at (untuk persiapan shalat Jum'at)");
          return;
        }
        
        // Validasi jam Jum'at
        if (data.waktu_mulai < "10:30" || data.waktu_selesai > "13:00") {
          alert("â° Hari Jum'at: booking hanya diperbolehkan pukul 10.30 - 13.00 WIB");
          return;
        }
      } else {
        // Validasi jam reguler (Senin-Kamis)
        if (data.waktu_mulai < "07:30" || data.waktu_selesai > "16:00") {
          alert("â° Waktu booking hanya 07.30 - 16.00 WIB (Senin-Kamis)");
          return;
        }
      }
      
      // Validasi waktu selesai > mulai
      if (data.waktu_mulai >= data.waktu_selesai) {
        alert("âŒ Waktu selesai harus setelah waktu mulai");
        return;
      }

      // ===== SIMPAN KE CLOUD =====
      let cloudOK = false;
      if (_supabase) {
        try {
          const { error } = await _supabase.from('bookings').insert([{
            ...data,
            created_at: new Date().toISOString(),
            device_id: navigator.userAgent
          }]);
          if (error) throw error;
          cloudOK = true;
        } catch (err) {
          console.error("Cloud error:", err);
        }
      }

      // ===== SIMPAN KE LOCAL (offline backup) =====
      try {
        const bookings = JSON.parse(localStorage.getItem('dream_bookings') || '[]');
        bookings.push({
          ...data, 
          timestamp: new Date().toISOString(),
          local_id: Date.now()
        });
        localStorage.setItem('dream_bookings', JSON.stringify(bookings));
      } catch (err) {
        console.warn("Local save failed");
      }

      // ===== KIRIM KE WHATSAPP =====
      const msg = `*BOOKING FASILITAS - SIF AL FIKRI*
Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙÙ‘Ù°Ù‡Ù Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù

ğŸ‘¤ *Pemohon:* ${data.nama}
ğŸ« *Divisi:* ${data.divisi}
ğŸ“± *WhatsApp:* ${data.whatsapp || 'â€“'}
ğŸ¢ *Sarana:* ${data.sarana}
ğŸ“… *Tanggal:* ${formatDate(data.tanggal)}
â° *Waktu:* ${data.waktu_mulai} - ${data.waktu_selesai}
ğŸ“ *Keterangan:* ${data.keterangan}

âš ï¸ *Catatan:* ${isFriday ? "HARI JUM'AT - Perhatikan waktu shalat Jum'at" : "Normal"}

_â€” Dream OS v4.4.1 Hybrid Cloud â€¢ otomatis dari sistem_`;
      
      // âœ… WhatsApp URL TANPA SPASI
      window.open(`https://wa.me/${WA_PAK_ERWIN}?text=${encodeURIComponent(msg)}`, '_blank');
      
      showToast(`âœ… ${cloudOK ? 'Tersimpan di cloud' : 'Dikirim via WA'} ${!navigator.onLine ? '(offline mode)' : ''}`);
      showMainMenu();
      renderMiniCalendar(); // Refresh calendar
    }

    // ========== K3 ==========
    function showK3Form() {
      const html = `
        <div class="card">
          <h2 style="margin-bottom:15px">âš ï¸ Laporan K3 + Kamera</h2>
          <form id="k3Form">
            <div class="form-group">
              <label class="form-label">Jenis Laporan *</label>
              <select id="k3_jenis" class="form-select" required>
                <option value="">-- Pilih Jenis --</option>
                <option value="Kerusakan">Kerusakan (Maintenance)</option>
                <option value="Kehilangan">Kehilangan (Security)</option>
                <option value="Kebersihan">Kebersihan (Cleaning Service)</option>
                <option value="Emergency">Emergency (Priority 1)</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Lokasi *</label>
              <input type="text" id="k3_lokasi" class="form-input" placeholder="Contoh: Lab Komputer 1, Koridor lantai 2" required>
            </div>
            <div class="form-group">
              <label class="form-label">Barang / Masalah *</label>
              <input type="text" id="k3_barang" class="form-input" placeholder="AC rusak, kursi patah, kebocoran..." required>
            </div>
            <div class="form-group">
              <label class="form-label">Deskripsi Detail *</label>
              <textarea id="k3_deskripsi" class="form-textarea" rows="4" placeholder="Jelaskan secara detail kondisi, lokasi tepat, tingkat urgensi..." required></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Foto Dokumentasi</label>
              <input type="file" id="k3_foto" accept="image/*" capture="environment" class="form-input">
              <small style="color:#666;">ğŸ“¸ Ambil foto langsung dari kamera</small>
              <img id="fotoPreview" class="img-preview" alt="Preview">
            </div>
            <button type="submit" class="btn">ğŸ“¤ Kirim Laporan ke Pak Erwin</button>
            <button type="button" class="btn btn-secondary" onclick="showMainMenu()">â† Kembali</button>
          </form>
        </div>
      `;
      document.getElementById('form-container').innerHTML = html;
      document.getElementById('menu-grid').classList.add('hidden');
      document.getElementById('form-container').classList.remove('hidden');
      
      // Preview foto
      document.getElementById('k3_foto')?.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const preview = document.getElementById('fotoPreview');
            preview.src = e.target.result;
            preview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      });
      
      document.getElementById('k3Form').onsubmit = submitK3;
    }

    async function submitK3(e) {
      e.preventDefault();
      const data = {
        jenis: document.getElementById('k3_jenis').value,
        lokasi: document.getElementById('k3_lokasi').value,
        barang: document.getElementById('k3_barang').value,
        deskripsi: document.getElementById('k3_deskripsi').value,
        has_photo: document.getElementById('k3_foto')?.files.length > 0
      };

      // Simpan ke cloud
      if (_supabase) {
        try {
          await _supabase.from('k3_reports').insert([{
            ...data,
            created_at: new Date().toISOString(),
            device: navigator.userAgent
          }]);
        } catch (err) {
          console.error("K3 cloud error:", err);
        }
      }

      // Simpan ke local
      try {
        const reports = JSON.parse(localStorage.getItem('dream_k3') || '[]');
        reports.push({
          ...data, 
          timestamp: new Date().toISOString(),
          local_id: Date.now()
        });
        localStorage.setItem('dream_k3', JSON.stringify(reports));
      } catch (err) {
        console.warn("Local K3 save failed");
      }

      // Kirim ke WA
      const team = data.jenis === 'Kehilangan' ? 'SECURITY' :
                   data.jenis === 'Kebersihan' ? 'CLEANING SERVICE' :
                   data.jenis === 'Emergency' ? 'MAINTENANCE (EMERGENCY)' : 'MAINTENANCE';
      
      const msg = `*LAPORAN K3 - ${team}*
Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙÙ‘Ù°Ù‡Ù Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù

â— *Jenis:* ${data.jenis}
ğŸ“ *Lokasi:* ${data.lokasi}
ğŸ”§ *Barang:* ${data.barang || 'â€“'}
ğŸ“ *Deskripsi:* ${data.deskripsi}
ğŸ“¸ *Foto:* ${data.has_photo ? 'TERSEDIA' : 'TIDAK ADA'}

ğŸš¨ *Priority:* ${data.jenis === 'Emergency' ? 'TINGGI (segera tangani)' : 'Normal'}

_â€” Dream OS v4.4.1 â€¢ Routing otomatis ke Pak Erwin_`;
      
      // âœ… WhatsApp URL TANPA SPASI
      window.open(`https://wa.me/${WA_PAK_ERWIN}?text=${encodeURIComponent(msg)}`, '_blank');
      
      showToast(`âœ… Laporan K3 terkirim ke ${team}!`);
      showMainMenu();
    }

    // ========== ADMIN & BACKUP ==========
    function showAdminPanel() {
      const pass = prompt("Masukkan password admin:");
      if (pass !== "alfikri2025") {
        showToast("âŒ Password salah!");
        return;
      }

      // Ambil data dari cloud
      let totalBooking = 0, totalK3 = 0;
      if (_supabase) {
        _supabase.from('bookings').select('id', { count: 'exact' }).then(res => {
          totalBooking = res.count || 0;
          document.getElementById('stat-booking')?.innerText = totalBooking;
        });
        _supabase.from('k3_reports').select('id', { count: 'exact' }).then(res => {
          totalK3 = res.count || 0;
          document.getElementById('stat-k3')?.innerText = totalK3;
        });
      }

      // Data lokal
      const localBookings = JSON.parse(localStorage.getItem('dream_bookings') || '[]').length;
      const localK3 = JSON.parse(localStorage.getItem('dream_k3') || '[]').length;

      const html = `
        <div class="card">
          <h2 style="margin-bottom:15px">ğŸ” Dashboard Admin</h2>
          
          <div style="background:#EAF7ED; padding:15px; border-radius:10px; margin-bottom:20px;">
            <h3 style="margin-bottom:10px;">ğŸ“Š Statistik Sistem</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              <div style="background:white; padding:10px; border-radius:8px;">
                <div style="font-size:0.8rem; color:#666;">Booking (Cloud)</div>
                <div style="font-size:1.5rem; font-weight:bold;" id="stat-booking">${totalBooking}</div>
              </div>
              <div style="background:white; padding:10px; border-radius:8px;">
                <div style="font-size:0.8rem; color:#666;">K3 (Cloud)</div>
                <div style="font-size:1.5rem; font-weight:bold;" id="stat-k3">${totalK3}</div>
              </div>
              <div style="background:white; padding:10px; border-radius:8px;">
                <div style="font-size:0.8rem; color:#666;">Booking (Lokal)</div>
                <div style="font-size:1.5rem; font-weight:bold;">${localBookings}</div>
              </div>
              <div style="background:white; padding:10px; border-radius:8px;">
                <div style="font-size:0.8rem; color:#666;">K3 (Lokal)</div>
                <div style="font-size:1.5rem; font-weight:bold;">${localK3}</div>
              </div>
            </div>
          </div>
          
          <div style="display:flex; flex-direction:column; gap:10px;">
            <button class="btn" onclick="backupData()">ğŸ’¾ Backup Data Lengkap</button>
            <button class="btn" onclick="exportCloudData()">â˜ï¸ Export Cloud Data</button>
            <button class="btn" onclick="clearLocalData()">ğŸ—‘ï¸ Hapus Data Lokal</button>
            <button class="btn btn-secondary" onclick="showMainMenu()">â† Kembali ke Menu</button>
          </div>
        </div>
      `;
      document.getElementById('form-container').innerHTML = html;
      document.getElementById('menu-grid').classList.add('hidden');
      document.getElementById('form-container').classList.remove('hidden');
    }

    function backupData() {
      const bookings = localStorage.getItem('dream_bookings') || '[]';
      const k3 = localStorage.getItem('dream_k3') || '[]';
      const data = {
        system: "Dream OS v4.4.1",
        backup_at: new Date().toISOString(),
        device: navigator.userAgent,
        online: navigator.onLine,
        bookings: JSON.parse(bookings),
        k3_reports: JSON.parse(k3)
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `dreamos-backup-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast("âœ… Backup data lokal berhasil!");
    }

    async function exportCloudData() {
      if (!_supabase) {
        showToast("âŒ Tidak terhubung ke cloud");
        return;
      }
      
      try {
        const [bookingsRes, k3Res] = await Promise.all([
          _supabase.from('bookings').select('*'),
          _supabase.from('k3_reports').select('*')
        ]);
        
        const data = {
          system: "Dream OS Cloud Export",
          exported_at: new Date().toISOString(),
          bookings: bookingsRes.data || [],
          k3_reports: k3Res.data || []
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `dreamos-cloud-export-${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast("âœ… Export data cloud berhasil!");
      } catch (err) {
        showToast("âŒ Gagal export data cloud");
      }
    }

    function clearLocalData() {
      if (confirm("Yakin hapus SEMUA data lokal? Data cloud tidak terpengaruh.")) {
        localStorage.removeItem('dream_bookings');
        localStorage.removeItem('dream_k3');
        showToast("ğŸ—‘ï¸ Data lokal telah dihapus");
        setTimeout(showMainMenu, 1000);
      }
    }

    // ========== ONLINE/OFFLINE ==========
    window.addEventListener('online', () => {
      document.getElementById('sync-status').innerText = "ğŸŸ¢ CLOUD ACTIVE";
      try {
        _supabase = supabase.createClient(SB_URL, SB_KEY);
      } catch (e) {}
    });
    
    window.addEventListener('offline', () => {
      document.getElementById('sync-status').innerText = "ğŸ”´ OFFLINE MODE";
    });

    // ========== INITIALIZE ==========
    document.addEventListener('DOMContentLoaded', () => {
      renderMiniCalendar();
      
      // Auto-update status
      if (!navigator.onLine) {
        document.getElementById('sync-status').innerText = "ğŸ”´ OFFLINE MODE";
      }
    });
  </script>
</body>
</html>
