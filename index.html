<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#006400">
    <title>üè¢ Dream OS Ultimate - FIXED KAI VERSION</title>
    
    <!-- SUPABASE -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
    /* KAIOS STYLE - MINIMAL CSS */
    :root { 
        --primary: #006400; 
        --accent: #FD0; 
        --danger: #F00; 
        --gold: #FD0; 
        --bg: #000;
        --card: #111;
        --text: #FFF;
    }
    
    * { 
        margin: 0; 
        padding: 0; 
        box-sizing: border-box; 
        -webkit-tap-highlight-color: transparent;
    }
    
    body { 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
        background: var(--bg); 
        color: var(--text); 
        padding: 10px;
        min-height: 100vh;
    }
    
    /* HEADER */
    .header { 
        text-align: center; 
        padding: 15px; 
        border-bottom: 2px solid var(--primary); 
        margin-bottom: 15px; 
    }
    
    .title { 
        font-size: 20px; 
        color: var(--accent); 
        margin: 5px 0;
    }
    
    .subtitle { 
        font-size: 12px; 
        color: #94A3B8;
        margin-bottom: 5px;
    }
    
    /* STATS */
    .stats { 
        display: grid; 
        grid-template-columns: repeat(2, 1fr); 
        gap: 10px; 
        margin: 15px 0; 
    }
    
    .stat-card { 
        background: var(--card); 
        border-radius: 10px; 
        padding: 15px; 
        text-align: center; 
        border: 1px solid #333; 
    }
    
    .stat-number { 
        font-size: 24px; 
        color: var(--accent); 
        font-weight: bold; 
    }
    
    .stat-label { 
        font-size: 12px; 
        color: #94A3B8;
        margin-top: 5px;
    }
    
    /* BUTTONS */
    .btn-grid { 
        display: grid; 
        grid-template-columns: repeat(2, 1fr); 
        gap: 8px; 
        margin: 15px 0; 
    }
    
    .btn { 
        background: var(--primary); 
        color: white; 
        border: none; 
        padding: 12px; 
        border-radius: 8px; 
        font-size: 14px; 
        text-align: center;
        cursor: pointer;
        transition: transform 0.1s;
    }
    
    .btn:active {
        transform: scale(0.98);
        background: #004d00;
    }
    
    .btn-warning { background: #F57C00; }
    .btn-warning:active { background: #E65100; }
    
    .btn-success { background: #25D366; }
    .btn-success:active { background: #1DA851; }
    
    .btn-danger { background: #C62828; }
    .btn-danger:active { background: #B71C1C; }
    
    /* CALENDAR */
    .calendar-box { 
        background: var(--card); 
        border-radius: 10px; 
        padding: 15px; 
        margin-top: 15px;
        border: 1px solid #333;
    }
    
    .calendar-title {
        color: var(--gold); 
        margin-bottom: 10px;
        font-size: 14px;
    }
    
    .day-box {
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #333;
    }
    
    .day-box:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    
    .booking-item-small {
        background: rgba(0, 100, 0, 0.2);
        padding: 3px 6px;
        margin: 2px 0;
        border-radius: 4px;
        font-size: 11px;
    }
    
    /* MODALS */
    .modal { 
        display: none; 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(0,0,0,0.9); 
        z-index: 1000; 
        padding: 10px;
        overflow-y: auto;
        animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .modal-content { 
        background: var(--card); 
        border-radius: 10px; 
        padding: 15px; 
        margin: 0 auto; 
        max-width: 500px;
        border: 2px solid var(--primary);
        animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #333;
    }
    
    .modal-title {
        color: var(--gold);
        font-weight: bold;
        font-size: 16px;
    }
    
    .modal-close {
        background: #333;
        color: var(--text);
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* FORMS */
    .form-group { 
        margin-bottom: 12px; 
    }
    
    .form-label {
        display: block;
        margin-bottom: 5px;
        color: #94A3B8;
        font-size: 12px;
    }
    
    .form-input, 
    .form-select, 
    .form-textarea { 
        width: 100%; 
        padding: 10px; 
        background: #222; 
        border: 1px solid #444; 
        border-radius: 6px; 
        color: var(--text); 
        font-size: 14px; 
    }
    
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
        outline: none;
        border-color: var(--primary);
    }
    
    /* ADMIN PANEL */
    .admin-panel {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .admin-item {
        border-bottom: 1px solid #333;
        padding: 10px 0;
    }
    
    .admin-item:last-child {
        border-bottom: none;
    }
    
    .admin-actions {
        margin-top: 5px;
    }
    
    .btn-small {
        padding: 4px 10px;
        font-size: 12px;
        border-radius: 4px;
        margin-right: 5px;
    }
    
    /* LOADING */
    .loading {
        text-align: center;
        padding: 20px;
        color: #94A3B8;
    }
    
    /* STATUS BADGES */
    .status-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 10px;
        margin-left: 5px;
        font-weight: bold;
    }
    
    .status-pending { background: #92400e; color: #fbbf24; }
    .status-confirmed { background: #065f46; color: #34d399; }
    .status-rejected { background: #991b1b; color: #f87171; }
    
    /* FOOTER */
    .footer {
        text-align: center;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #333;
        color: #64748B;
        font-size: 11px;
    }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="header">
        <div style="font-size: 32px; margin-bottom: 5px;">üè¢</div>
        <div class="title">DREAM OS ULTIMATE</div>
        <div class="subtitle">Kai Version ‚Ä¢ Double Booking Prevention ‚Ä¢ Admin Panel</div>
        <div id="connectionStatus" style="color: #0A0; font-size: 11px; margin-top: 5px;">Loading connection...</div>
    </div>
    
    <!-- STATS DASHBOARD -->
    <div class="stats" id="dashboardStats">
        <div class="stat-card">
            <div class="stat-number" id="statsBookings">0</div>
            <div class="stat-label">Today's Bookings</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="statsFacilities">0</div>
            <div class="stat-label">Available Facilities</div>
        </div>
    </div>
    
    <!-- QUICK ACTIONS -->
    <div class="btn-grid">
        <button class="btn" onclick="openModal('booking')">üìÖ New Booking</button>
        <button class="btn btn-warning" onclick="openModal('calendar')">üóìÔ∏è View Calendar</button>
        <button class="btn btn-success" onclick="window.open('https://wa.me/628886183954')">üì± WhatsApp</button>
        <button class="btn btn-danger" onclick="openAdmin()">üîê Admin</button>
    </div>
    
    <!-- CALENDAR PREVIEW -->
    <div class="calendar-box">
        <div class="calendar-title">üìÖ Next 3 Days</div>
        <div id="calendarPreview" class="loading">Loading calendar...</div>
    </div>
    
    <!-- MODAL: NEW BOOKING -->
    <div class="modal" id="modalBooking">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üìÖ New Booking</div>
                <button class="modal-close" onclick="closeModal('booking')">√ó</button>
            </div>
            
            <form id="bookingForm">
                <div class="form-group">
                    <label class="form-label">Your Name *</label>
                    <input type="text" class="form-input" id="bookingName" placeholder="Enter your full name" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone Number *</label>
                    <input type="tel" class="form-input" id="bookingPhone" placeholder="628xxxxxxx" required>
                    <small style="color: #94A3B8; font-size: 10px;">Must start with 628</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Division *</label>
                    <select class="form-select" id="bookingDivision" required>
                        <option value="">Select Division</option>
                        <option value="SD">SD</option>
                        <option value="SMP">SMP</option>
                        <option value="SMA">SMA</option>
                        <option value="Umum">Umum</option>
                        <option value="Guru">Guru</option>
                        <option value="Staff">Staff</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Facility *</label>
                    <select class="form-select" id="bookingFacility" required>
                        <option value="">Loading facilities...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Date *</label>
                    <input type="date" class="form-input" id="bookingDate" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Start Time *</label>
                    <input type="time" class="form-input" id="bookingTime" required value="08:00">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Purpose</label>
                    <input type="text" class="form-input" id="bookingPurpose" placeholder="Meeting, Workshop, etc">
                </div>
                
                <button type="submit" class="btn" style="width:100%; margin-top: 10px;">
                    üì§ Submit Booking
                </button>
            </form>
        </div>
    </div>
    
    <!-- MODAL: CALENDAR VIEW -->
    <div class="modal" id="modalCalendar">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üóìÔ∏è 7-Day Calendar</div>
                <button class="modal-close" onclick="closeModal('calendar')">√ó</button>
            </div>
            
            <div id="calendarFullView" class="loading">
                Loading full calendar...
            </div>
        </div>
    </div>
    
    <!-- FOOTER -->
    <div class="footer">
        <p>Dream OS Ultimate Kai v1.0.0</p>
        <p>‚ö° Optimized for Redmi Note 9 Pro ‚Ä¢ üì± Mobile First</p>
        <p>üáÆüá©üáµüá∏ Made with ‚ù§Ô∏è for Indonesia</p>
    </div>
    
    <!-- MAIN JAVASCRIPT -->
    <script>
    // ============================================
    // üè¢ DREAM OS ULTIMATE - KAI VERSION
    // COMPLETE VERSION - READY TO DEPLOY
    // ============================================
    
    // CONFIGURATION
    const CONFIG = {
        SUPABASE: {
            URL: 'https://mugrsslvjaisdcexbybg.supabase.co',
            KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11Z3Jzc2x2amFpc2RjZXhieWJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzUwMzk4MzQsImV4cCI6MjA1MDYxNTgzNH0.74xqJXaUuYAcMmkZ3ZqY_hJIs9e-TvE1yA-zF2vZ-x4'
        },
        TABLES: {
            FACILITIES: 'dream_kai_facilities',
            BOOKINGS: 'dream_kai_bookings'
        },
        ADMIN_PASSWORD: 'b15m1ll4h_C1nt41001',
        WHATSAPP_NUMBER: '628886183954'
    };
    
    // GLOBAL VARIABLES
    let supabase = null;
    let isAdmin = false;
    let facilities = [];
    
    // ============================================
    // INITIALIZATION
    // ============================================
    
    async function initApp() {
        console.log('üöÄ Initializing Dream OS Ultimate...');
        
        try {
            // Initialize Supabase
            supabase = window.supabase.createClient(
                CONFIG.SUPABASE.URL,
                CONFIG.SUPABASE.KEY
            );
            
            // Test connection
            const connectionOk = await testConnection();
            
            if (connectionOk) {
                showStatus('‚úÖ Connected to Database', 'success');
                
                // Load all initial data
                await loadAllData();
                
                // Setup event listeners
                setupEventListeners();
                
                console.log('‚úÖ Dream OS Ultimate ready!');
            } else {
                showStatus('‚ö†Ô∏è Limited Mode - Using offline data', 'warning');
                loadOfflineData();
            }
            
        } catch (error) {
            console.error('‚ùå Initialization failed:', error);
            showStatus('‚ùå Offline Mode', 'danger');
            loadOfflineData();
        }
    }
    
    // ============================================
    // CONNECTION & DATA LOADING
    // ============================================
    
    async function testConnection() {
        try {
            const { data, error } = await supabase
                .from(CONFIG.TABLES.FACILITIES)
                .select('count', { count: 'exact', head: true });
            
            return !error;
        } catch (error) {
            return false;
        }
    }
    
    async function loadAllData() {
        try {
            // Load facilities for dropdown
            await loadFacilities();
            
            // Load dashboard stats
            await loadDashboardStats();
            
            // Load calendar preview
            await loadCalendarPreview();
            
        } catch (error) {
            console.error('Error loading data:', error);
        }
    }
    
    async function loadFacilities() {
        try {
            const { data, error } = await supabase
                .from(CONFIG.TABLES.FACILITIES)
                .select('id, nama_fasilitas, kode_fasilitas, lokasi, kapasitas')
                .eq('status', 'available')
                .order('nama_fasilitas');
            
            if (error) throw error;
            
            facilities = data || [];
            
            // Update dropdown
            const select = document.getElementById('bookingFacility');
            select.innerHTML = '<option value="">Select facility...</option>';
            
            facilities.forEach(facility => {
                const option = document.createElement('option');
                option.value = facility.id;
                option.textContent = `${facility.nama_fasilitas} (${facility.lokasi}) - ${facility.kapasitas} orang`;
                select.appendChild(option);
            });
            
            // Set default date (tomorrow)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('bookingDate').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('bookingDate').min = new Date().toISOString().split('T')[0];
            
        } catch (error) {
            console.error('Error loading facilities:', error);
            showAlert('‚ö†Ô∏è Cannot load facilities. Please try again.', 'warning');
        }
    }
    
    async function loadDashboardStats() {
        try {
            const today = new Date().toISOString().split('T')[0];
            
            // Get today's bookings count
            const { count: todayBookings } = await supabase
                .from(CONFIG.TABLES.BOOKINGS)
                .select('*', { count: 'exact', head: true })
                .eq('tanggal', today);
            
            // Get available facilities count
            const { count: availableFacilities } = await supabase
                .from(CONFIG.TABLES.FACILITIES)
                .select('*', { count: 'exact', head: true })
                .eq('status', 'available');
            
            // Update UI
            document.getElementById('statsBookings').textContent = todayBookings || 0;
            document.getElementById('statsFacilities').textContent = availableFacilities || 0;
            
        } catch (error) {
            console.error('Error loading dashboard stats:', error);
        }
    }
    
    async function loadCalendarPreview() {
        try {
            const today = new Date();
            let html = '';
            
            for (let i = 0; i < 3; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const dayName = date.toLocaleDateString('id-ID', { weekday: 'short' });
                
                const { data } = await supabase
                    .from(CONFIG.TABLES.BOOKINGS)
                    .select(`
                        nama_pemesan,
                        jam_mulai,
                        jam_selesai,
                        ${CONFIG.TABLES.FACILITIES}(nama_fasilitas)
                    `)
                    .eq('tanggal', dateStr)
                    .in('status', ['pending', 'confirmed'])
                    .order('jam_mulai')
                    .limit(3);
                
                html += `<div class="day-box">
                    <strong>${dayName}, ${date.getDate()}/${date.getMonth()+1}</strong><br>`;
                
                if (!data || data.length === 0) {
                    html += '<small style="color:#94A3B8;">No bookings</small>';
                } else {
                    data.forEach(booking => {
                        const start = booking.jam_mulai.substring(0, 5);
                        const end = booking.jam_selesai.substring(0, 5);
                        const facilityName = booking.dream_kai_facilities?.nama_fasilitas || 'Unknown';
                        
                        html += `<div class="booking-item-small">
                            ${start}-${end}: ${facilityName}
                        </div>`;
                    });
                }
                html += '</div>';
            }
            
            document.getElementById('calendarPreview').innerHTML = html;
            
        } catch (error) {
            console.error('Error loading calendar:', error);
            document.getElementById('calendarPreview').innerHTML = 
                '<div style="color:#94A3B8;">Failed to load calendar</div>';
        }
    }
    
    async function loadFullCalendar() {
        try {
            const today = new Date();
            let html = '';
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const dayName = date.toLocaleDateString('id-ID', { weekday: 'long' });
                
                const { data } = await supabase
                    .from(CONFIG.TABLES.BOOKINGS)
                    .select(`
                        nama_pemesan,
                        jam_mulai,
                        jam_selesai,
                        tujuan,
                        ${CONFIG.TABLES.FACILITIES}(nama_fasilitas)
                    `)
                    .eq('tanggal', dateStr)
                    .in('status', ['pending', 'confirmed'])
                    .order('jam_mulai');
                
                html += `<div class="day-box">
                    <strong>${dayName}, ${date.getDate()}/${date.getMonth()+1}</strong>`;
                
                if (!data || data.length === 0) {
                    html += '<div style="color:#94A3B8; padding:10px 0;">No bookings scheduled</div>';
                } else {
                    data.forEach(booking => {
                        const start = booking.jam_mulai.substring(0, 5);
                        const end = booking.jam_selesai.substring(0, 5);
                        const facilityName = booking.dream_kai_facilities?.nama_fasilitas || 'Unknown';
                        
                        html += `<div class="booking-item-small">
                            <strong>${start}-${end}</strong><br>
                            ${facilityName}<br>
                            <small>${booking.nama_pemesan} - ${booking.tujuan}</small>
                        </div>`;
                    });
                }
                html += '</div>';
            }
            
            document.getElementById('calendarFullView').innerHTML = html;
            
        } catch (error) {
            console.error('Error loading full calendar:', error);
            document.getElementById('calendarFullView').innerHTML = 
                '<div style="color:#94A3B8; text-align:center; padding:20px;">Failed to load calendar</div>';
        }
    }
    
    // ============================================
    // BOOKING SYSTEM
    // ============================================
    
    function setupEventListeners() {
        // Booking form submission
        document.getElementById('bookingForm').addEventListener('submit', handleBookingSubmit);
        
        // Real-time updates for calendar
        setupRealtimeUpdates();
    }
    
    async function handleBookingSubmit(event) {
        event.preventDefault();
        
        // Get form values
        const name = document.getElementById('bookingName').value.trim();
        const phone = document.getElementById('bookingPhone').value.trim();
        const division = document.getElementById('bookingDivision').value;
        const facilityId = document.getElementById('bookingFacility').value;
        const date = document.getElementById('bookingDate').value;
        const time = document.getElementById('bookingTime').value;
        const purpose = document.getElementById('bookingPurpose').value.trim() || `${division} Meeting`;
        
        // Validation
        if (!name || !phone || !division || !facilityId || !date || !time) {
            showAlert('‚ùå Please fill all required fields', 'danger');
            return;
        }
        
        if (!phone.startsWith('628')) {
            showAlert('‚ùå Phone number must start with 628', 'danger');
            return;
        }
        
        // Check for double booking
        const availabilityCheck = await checkDoubleBooking(facilityId, date, time, phone);
        if (!availabilityCheck.available) {
            showAlert(`‚ùå ${availabilityCheck.message}`, 'danger');
            return;
        }
        
        // Submit booking
        try {
            const result = await submitBooking({
                name: name,
                phone: phone,
                division: division,
                facilityId: parseInt(facilityId),
                date: date,
                time: time,
                purpose: purpose
            });
            
            if (result.success) {
                // Success!
                showAlert(`‚úÖ Booking submitted successfully!\nBooking Code: ${result.data.kode_booking}`, 'success');
                
                // Send WhatsApp notification
                sendWhatsAppNotification({
                    name: name,
                    phone: phone,
                    division: division,
                    date: date,
                    time: time,
                    purpose: purpose,
                    bookingCode: result.data.kode_booking
                });
                
                // Reset form
                event.target.reset();
                
                // Close modal
                closeModal('booking');
                
                // Refresh data
                await Promise.all([
                    loadDashboardStats(),
                    loadCalendarPreview()
                ]);
                
            } else {
                throw new Error(result.error);
            }
            
        } catch (error) {
            console.error('Booking error:', error);
            showAlert(`‚ùå Booking failed: ${error.message}`, 'danger');
        }
    }
    
    async function checkDoubleBooking(facilityId, date, time, phone) {
        try {
            // Convert time to minutes
            const [h, m] = time.split(':').map(Number);
            const startMinutes = h * 60 + m;
            const endMinutes = startMinutes + 60; // 1 hour default
            
            // Get existing bookings
            const { data } = await supabase
                .from(CONFIG.TABLES.BOOKINGS)
                .select('jam_mulai, jam_selesai, no_hp')
                .eq('facility_id', facilityId)
                .eq('tanggal', date)
                .in('status', ['pending', 'confirmed']);
            
            if (!data || data.length === 0) {
                return { available: true };
            }
            
            // Check for time conflicts
            for (const booking of data) {
                const [bh, bm] = booking.jam_mulai.split(':').map(Number);
                const [eh, em] = booking.jam_selesai.split(':').map(Number);
                const bookingStart = bh * 60 + bm;
                const bookingEnd = eh * 60 + em;
                
                // Time overlap check
                if (startMinutes < bookingEnd && endMinutes > bookingStart) {
                    return { 
                        available: false, 
                        message: 'Facility already booked at this time' 
                    };
                }
                
                // Same phone check (max 1 booking per day)
                if (booking.no_hp === phone) {
                    return { 
                        available: false, 
                        message: 'You already have a booking today' 
                    };
                }
            }
            
            return { available: true };
            
        } catch (error) {
            console.error('Double booking check error:', error);
            return { 
                available: false, 
                message: 'System error checking availability' 
            };
        }
    }
    
    async function submitBooking(bookingData) {
        try {
            // Calculate end time (1 hour after start)
            const [h, m] = bookingData.time.split(':').map(Number);
            const endHour = (h + 1) % 24;
            const endTime = `${endHour.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
            
            const { data, error } = await supabase
                .from(CONFIG.TABLES.BOOKINGS)
                .insert([{
                    nama_pemesan: bookingData.name,
                    no_hp: bookingData.phone,
                    email: null,
                    facility_id: bookingData.facilityId,
                    tanggal: bookingData.date,
                    jam_mulai: bookingData.time + ':00',
                    jam_selesai: endTime + ':00',
                    tujuan: bookingData.purpose,
                    jumlah_orang: 1,
                    catatan: null,
                    status: 'pending'
                }])
                .select();
            
            if (error) throw error;
            
            return { success: true, data: data[0] };
            
        } catch (error) {
            console.error('Submit booking error:', error);
            return { success: false, error: error.message };
        }
    }
    
    // ============================================
    // ADMIN FUNCTIONS
    // ============================================
    
    async function openAdmin() {
        const password = prompt('üîê Enter admin password:');
        if (password !== CONFIG.ADMIN_PASSWORD) {
            showAlert('‚ùå Wrong password', 'danger');
            return;
        }
        
        isAdmin = true;
        
        try {
            // Load all bookings
            const { data, error } = await supabase
                .from(CONFIG.TABLES.BOOKINGS)
                .select(`
                    *,
                    ${CONFIG.TABLES.FACILITIES}(nama_fasilitas, lokasi)
                `)
                .order('created_at', { ascending: false })
                .limit(50);
            
            if (error) throw error;
            
            showAdminPanel(data || []);
            
        } catch (error) {
            console.error('Admin panel error:', error);
            showAlert('‚ùå Failed to load admin data', 'danger');
        }
    }
    
    function showAdminPanel(bookings) {
        let html = `
            <div class="modal-header">
                <div class="modal-title">üîê Admin Panel</div>
                <button class="modal-close" onclick="closeAdminPanel()">√ó</button>
            </div>
            
            <div class="admin-panel">
                <p style="margin-bottom: 15px; color: #94A3B8;">Total bookings: ${bookings.length}</p>
        `;
        
        if (bookings.length === 0) {
            html += '<p style="text-align: center; padding: 20px; color: #94A3B8;">No bookings found</p>';
        } else {
            bookings.forEach(booking => {
                const facility = booking.dream_kai_facilities;
                const statusClass = `status-${booking.status}`;
                
                html += `
                    <div class="admin-item">
                        <strong>${booking.nama_pemesan}</strong>
                        <span class="status-badge ${statusClass}">${booking.status}</span><br>
                        üìû ${booking.no_hp}<br>
                        üè¢ ${facility?.nama_fasilitas || 'Unknown'} (${facility?.lokasi || '-'})<br>
                        üìÖ ${booking.tanggal} ${booking.jam_mulai.substring(0,5)}<br>
                        üìù ${booking.tujuan}<br>
                        <small>Code: ${booking.kode_booking}</small>
                        
                        <div class="admin-actions">
                            ${booking.status === 'pending' ? 
                                `<button class="btn-small" style="background:#0A0;" 
                                        onclick="updateBookingStatus(${booking.id}, 'confirmed')">
                                    ‚úÖ Approve
                                </button>` : ''}
                            
                            <button class="btn-small" style="background:#F00;" 
                                    onclick="updateBookingStatus(${booking.id}, 'rejected')">
                                ‚ùå Reject
                            </button>
                            
                            <button class="btn-small" style="background:#333;" 
                                    onclick="deleteBooking(${booking.id})">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            });
        }
        
        html += '</div>';
        
        // Create modal for admin panel
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.id = 'modalAdmin';
        modal.innerHTML = `<div class="modal-content" style="max-width: 600px;">${html}</div>`;
        
        document.body.appendChild(modal);
    }
    
    async function updateBookingStatus(bookingId, newStatus) {
        if (!confirm(`Change booking status to "${newStatus}"?`)) return;
        
        try {
            const { error } = await supabase
                .from(CONFIG.TABLES.BOOKINGS)
                .update({ status: newStatus })
                .eq('id', bookingId);
            
            if (error) throw error;
            
            showAlert(`‚úÖ Booking ${newStatus === 'confirmed' ? 'approved' : 'rejected'}!`, 'success');
            
            // Refresh admin panel
            if (isAdmin) {
                closeAdminPanel();
                await openAdmin();
            }
            
            // Refresh dashboard
            await loadDashboardStats();
            await loadCalendarPreview();
            
        } catch (error) {
            console.error('Update status error:', error);
            showAlert('‚ùå Failed to update status', 'danger');
        }
    }
    
    async function deleteBooking(bookingId) {
        if (!confirm('‚ö†Ô∏è Delete this booking permanently?')) return;
        
        try {
            const { error } = await supabase
                .from(CONFIG.TABLES.BOOKINGS)
                .delete()
                .eq('id', bookingId);
            
            if (error) throw error;
            
            showAlert('‚úÖ Booking deleted!', 'success');
            
            // Refresh admin panel
            if (isAdmin) {
                closeAdminPanel();
                await openAdmin();
            }
            
            // Refresh dashboard
            await loadDashboardStats();
            await loadCalendarPreview();
            
        } catch (error) {
            console.error('Delete booking error:', error);
            showAlert('‚ùå Failed to delete booking', 'danger');
        }
    }
    
    function closeAdminPanel() {
        const modal = document.getElementById('modalAdmin');
        if (modal) {
            modal.remove();
        }
    }
    
    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    
    function showStatus(message, type = 'info') {
        const element = document.getElementById('connectionStatus');
        if (!element) return;
        
        element.textContent = message;
        element.style.color = type === 'success' ? '#0A0' : 
                             type === 'warning' ? '#FF0' : 
                             type === 'danger' ? '#F00' : '#FFF';
    }
    
    function showAlert(message, type = 'info') {
        // Create alert element
        const alert = document.createElement('div');
        alert.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#065f46' : 
                        type === 'danger' ? '#991b1b' : 
                        type === 'warning' ? '#92400e' : '#1e293b'};
            color: ${type === 'success' ? '#34d399' : 
                    type === 'danger' ? '#f87171' : 
                    type === 'warning' ? '#fbbf24' : '#94A3B8'};
            padding: 12px 20px;
            border-radius: 8px;
            border: 1px solid ${type === 'success' ? '#34d399' : 
                              type === 'danger' ? '#f87171' : 
                              type === 'warning' ? '#fbbf24' : '#334155'};
            z-index: 9999;
            max-width: 300px;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        `;
        
        alert.innerHTML = message;
        
        document.body.appendChild(alert);
        
        // Remove after 5 seconds
        setTimeout(() => {
            alert.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => alert.remove(), 300);
        }, 5000);
    }
    
    function loadOfflineData() {
        document.getElementById('statsBookings').textContent = '0';
        document.getElementById('statsFacilities').textContent = '3';
        document.getElementById('calendarPreview').innerHTML = 
            '<div style="color:#94A3B8;">Offline mode - data not available</div>';
    }
    
    function openModal(modalName) {
        const modalId = 'modal' + modalName.charAt(0).toUpperCase() + modalName.slice(1);
        const modal = document.getElementById(modalId);
        
        if (modal) {
            modal.style.display = 'block';
            
            if (modalName === 'booking') {
                loadFacilities();
            } else if (modalName === 'calendar') {
                loadFullCalendar();
            }
        }
    }
    
    function closeModal(modalName) {
        const modalId = 'modal' + modalName.charAt(0).toUpperCase() + modalName.slice(1);
        const modal = document.getElementById(modalId);
        
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    function sendWhatsAppNotification(bookingData) {
        const message = `üìÖ NEW BOOKING - DREAM OS ULTIMATE\n\n` +
                       `üë§ Name: ${bookingData.name}\n` +
                       `üìû Phone: ${bookingData.phone}\n` +
                       `üè´ Division: ${bookingData.division}\n` +
                       `üìÖ Date: ${bookingData.date}\n` +
                       `‚è∞ Time: ${bookingData.time}\n` +
                       `üìù Purpose: ${bookingData.purpose}\n` +
                       `üîë Code: ${bookingData.bookingCode}\n` +
                       `\nStatus: Pending approval`;
        
        const encodedMessage = encodeURIComponent(message);
        window.open(`https://wa.me/${CONFIG.WHATSAPP_NUMBER}?text=${encodedMessage}`, '_blank');
    }
    
    function setupRealtimeUpdates() {
        if (!supabase) return;
        
        // Subscribe to booking changes
        supabase
            .channel('dream-kai-bookings')
            .on('postgres_changes', 
                { 
                    event: '*', 
                    schema: 'public', 
                    table: CONFIG.TABLES.BOOKINGS 
                }, 
                () => {
                    // Refresh data when bookings change
                    loadDashboardStats();
                    loadCalendarPreview();
                })
            .subscribe();
    }
    
    // Add CSS for animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
    
    // ============================================
    // INITIALIZE APP
    // ============================================
    
    document.addEventListener('DOMContentLoaded', initApp);
    
    // Make functions globally available
    window.openAdmin = openAdmin;
    window.updateBookingStatus = updateBookingStatus;
    window.deleteBooking = deleteBooking;
    window.closeAdminPanel = closeAdminPanel;
    window.openModal = openModal;
    window.closeModal = closeModal;
    
    console.log('‚ú® Dream OS Ultimate loaded successfully!');
    </script>
</body>
</html>
