<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè¢ Dream OS Enterprise</title>
    
    <!-- SUPABASE -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
    /* OPTIMIZED STYLE FOR REDMI NOTE 9 PRO */
    :root { --primary: #006400; --accent: #FD0; --danger: #F00; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: sans-serif; background: #000; color: #FFF; padding: 10px; }
    
    /* HEADER */
    .header { text-align: center; padding: 15px; border-bottom: 2px solid var(--primary); margin-bottom: 15px; }
    .title { font-size: 20px; color: var(--accent); }
    .subtitle { font-size: 12px; color: #888; }
    
    /* STATS */
    .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 15px 0; }
    .stat-card { background: #111; border-radius: 10px; padding: 15px; text-align: center; border: 1px solid #333; }
    .stat-number { font-size: 24px; color: var(--accent); font-weight: bold; }
    .stat-label { font-size: 12px; color: #888; }
    
    /* BUTTONS */
    .btn-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin: 15px 0; }
    .btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; font-size: 14px; text-align: center; }
    .btn-warning { background: #F57C00; }
    .btn-info { background: #2196F3; }
    .btn-danger { background: var(--danger); }
    
    /* MODAL */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100; padding: 10px; overflow-y: auto; }
    .modal-content { background: #111; border-radius: 10px; padding: 15px; margin: 0 auto; max-width: 500px; border: 2px solid var(--primary); }
    .modal-header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
    .modal-title { font-size: 18px; color: var(--accent); font-weight: bold; }
    .modal-close { background: #333; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; font-size: 20px; }
    
    /* FORM */
    .form-group { margin-bottom: 12px; }
    .form-label { display: block; margin-bottom: 5px; color: #888; font-size: 14px; }
    .form-input, .form-select { width: 100%; padding: 10px; background: #222; border: 1px solid #444; border-radius: 6px; color: white; font-size: 14px; }
    
    /* NOTIFICATIONS */
    .notification { background: #1a1a1a; border-left: 4px solid var(--accent); padding: 10px; margin-bottom: 8px; border-radius: 6px; }
    .notification.unread { border-left-color: var(--primary); }
    
    /* RESPONSIVE */
    @media (max-width: 768px) {
        .btn-grid { grid-template-columns: 1fr; }
        .stats { grid-template-columns: repeat(2, 1fr); }
    }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="header">
        <div class="title">üè¢ DREAM OS ENTERPRISE</div>
        <div class="subtitle">6 Tables Database ‚Ä¢ Real-time ‚Ä¢ Mobile Optimized</div>
        <div id="connectionStatus" style="color: #0A0; font-size: 12px; margin-top: 5px;">Loading...</div>
    </div>
    
    <!-- DASHBOARD STATS -->
    <div class="stats" id="dashboardStats">
        <!-- Will be filled by JavaScript -->
    </div>
    
    <!-- QUICK ACTIONS -->
    <div class="btn-grid">
        <button class="btn" onclick="openModal('booking')">
            üìÖ New Booking
        </button>
        <button class="btn btn-warning" onclick="openModal('k3')">
            ‚ö†Ô∏è Report K3
        </button>
        <button class="btn btn-info" onclick="openModal('notifications')">
            üîî Notifications
        </button>
        <button class="btn btn-danger" onclick="openAdmin()">
            üîê Admin Panel
        </button>
    </div>
    
    <!-- RECENT ACTIVITY -->
    <div style="background: #111; border-radius: 10px; padding: 15px; margin-top: 15px;">
        <div style="font-size: 16px; color: var(--accent); margin-bottom: 10px;">üìä Recent Activity</div>
        <div id="recentActivity">
            <div style="text-align: center; color: #888; padding: 20px;">Loading...</div>
        </div>
    </div>
    
    <!-- WHATSAPP BUTTON -->
    <button class="btn" style="background: #25D366; margin-top: 15px; width: 100%;" 
            onclick="window.open('https://wa.me/628886183954?text=Halo%20Pak%20Erwin,%20saya%20butuh%20bantuan%20terkait%20Dream%20OS%20Enterprise', '_blank')">
        üì± WhatsApp Pak Erwin
    </button>
    
    <!-- MODALS -->
    <div class="modal" id="modalBooking">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üìÖ New Booking</div>
                <button class="modal-close" onclick="closeModal('booking')">√ó</button>
            </div>
            <form id="bookingForm">
                <div class="form-group">
                    <label class="form-label">Facility</label>
                    <select class="form-select" id="bookingFacility" required>
                        <option value="">Loading facilities...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Purpose</label>
                    <input type="text" class="form-input" id="bookingPurpose" required placeholder="Meeting, Class, etc.">
                </div>
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" id="bookingDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Time</label>
                    <input type="time" class="form-input" id="bookingTime" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Duration (hours)</label>
                    <select class="form-select" id="bookingDuration">
                        <option value="1">1 hour</option>
                        <option value="2">2 hours</option>
                        <option value="3">3 hours</option>
                    </select>
                </div>
                <button type="submit" class="btn" style="width: 100%; margin-top: 10px;">
                    üì§ Submit Booking
                </button>
            </form>
        </div>
    </div>
    
    <!-- K3 REPORT MODAL -->
    <div class="modal" id="modalK3">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚ö†Ô∏è Report K3 Incident</div>
                <button class="modal-close" onclick="closeModal('k3')">√ó</button>
            </div>
            <form id="k3Form">
                <div class="form-group">
                    <label class="form-label">Incident Type</label>
                    <select class="form-select" id="k3Type" required>
                        <option value="">Select type...</option>
                        <option value="bahaya">Hazard/Danger</option>
                        <option value="kecelakaan">Accident</option>
                        <option value="hampir_celaka">Near Miss</option>
                        <option value="kondisi_tidak_aman">Unsafe Condition</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Severity</label>
                    <select class="form-select" id="k3Severity" required>
                        <option value="rendah">Low</option>
                        <option value="sedang">Medium</option>
                        <option value="tinggi">High</option>
                        <option value="kritis">Critical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-input" id="k3Location" required placeholder="Building, Room, etc.">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input" id="k3Description" rows="3" required></textarea>
                </div>
                <button type="submit" class="btn btn-warning" style="width: 100%;">
                    üö® Submit Report
                </button>
            </form>
        </div>
    </div>
    
    <!-- DREAM OS ENTERPRISE ENGINE -->
    <script>
    // ============================================
    // üè¢ DREAM OS ENTERPRISE ENGINE v2.0
    // OPTIMIZED FOR REDMI NOTE 9 PRO
    // ============================================
    
    // CONFIG
    const CONFIG = {
        SUPABASE: {
            URL: 'https://mugrsslvjaisdcexbybg.supabase.co',
            KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11Z3Jzc2x2amFpc2RjZXhieWJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzUwMzk4MzQsImV4cCI6MjA1MDYxNTgzNH0.74xqJXaUuYAcMmkZ3ZqY_hJIs9e-TvE1yA-zF2vZ-x4'
        },
        ADMIN_PASS: 'b15m1ll4h_2024'
    };
    
    // STATE
    let supabase = null;
    let currentUser = null;
    
    // INIT APP
    async function initApp() {
        showStatus('Connecting to Supabase...');
        
        try {
            // Init Supabase
            supabase = window.supabase.createClient(
                CONFIG.SUPABASE.URL,
                CONFIG.SUPABASE.KEY
            );
            
            // Test connection
            const { data, error } = await supabase
                .from('dream_facilities')
                .select('count', { count: 'exact', head: true });
            
            if (error) throw error;
            
            showStatus('‚úÖ Connected to Cloud');
            
            // Load demo user
            currentUser = {
                id: 'demo-user-001',
                nama_lengkap: 'Demo User',
                divisi: 'SMA',
                role: 'user'
            };
            
            // Load dashboard
            await loadDashboard();
            
            // Setup realtime
            setupRealtime();
            
            console.log('‚úÖ App initialized');
            
        } catch (error) {
            console.error('‚ùå Init failed:', error);
            showStatus('‚ùå Offline Mode');
            loadOfflineData();
        }
    }
    
    // LOAD DASHBOARD
    async function loadDashboard() {
        try {
            // Load stats
            const stats = await loadStats();
            updateStatsUI(stats);
            
            // Load recent activity
            await loadRecentActivity();
            
        } catch (error) {
            console.error('Dashboard error:', error);
        }
    }
    
    // LOAD STATS
    async function loadStats() {
        try {
            const [bookings, k3, facilities, notifications] = await Promise.all([
                getCount('dream_bookings'),
                getCount('dream_k3_reports'),
                getCount('dream_facilities'),
                getCount('dream_notifications', 'is_read', false)
            ]);
            
            return { bookings, k3, facilities, notifications };
            
        } catch (error) {
            return { bookings: 0, k3: 0, facilities: 0, notifications: 0 };
        }
    }
    
    // GET COUNT HELPER
    async function getCount(table, filterKey = null, filterValue = null) {
        try {
            let query = supabase.from(table).select('*', { count: 'exact', head: true });
            
            if (filterKey) {
                query = query.eq(filterKey, filterValue);
            }
            
            const { count } = await query;
            return count || 0;
            
        } catch (error) {
            return 0;
        }
    }
    
    // UPDATE STATS UI
    function updateStatsUI(stats) {
        const container = document.getElementById('dashboardStats');
        container.innerHTML = `
            <div class="stat-card">
                <div class="stat-number">${stats.bookings}</div>
                <div class="stat-label">Bookings</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${stats.k3}</div>
                <div class="stat-label">K3 Reports</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${stats.facilities}</div>
                <div class="stat-label">Facilities</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${stats.notifications}</div>
                <div class="stat-label">Notifications</div>
            </div>
        `;
    }
    
    // LOAD RECENT ACTIVITY
    async function loadRecentActivity() {
        try {
            // Get recent bookings
            const { data: bookings } = await supabase
                .from('dream_bookings')
                .select('booking_code, facility_id, status, created_at')
                .order('created_at', { ascending: false })
                .limit(5);
            
            // Get recent K3 reports
            const { data: k3 } = await supabase
                .from('dream_k3_reports')
                .select('report_code, jenis_insiden, status, created_at')
                .order('created_at', { ascending: false })
                .limit(5);
            
            const container = document.getElementById('recentActivity');
            let html = '';
            
            // Combine and sort
            const allActivities = [
                ...(bookings || []).map(b => ({ ...b, type: 'booking' })),
                ...(k3 || []).map(k => ({ ...k, type: 'k3' }))
            ].sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
             .slice(0, 8);
            
            if (allActivities.length === 0) {
                html = '<div style="color: #888; text-align: center; padding: 20px;">No activity yet</div>';
            } else {
                allActivities.forEach(activity => {
                    const time = new Date(activity.created_at).toLocaleTimeString('id-ID', { 
                        hour: '2-digit', minute: '2-digit' 
                    });
                    
                    if (activity.type === 'booking') {
                        html += `
                            <div style="padding: 8px 0; border-bottom: 1px solid #333;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>üìÖ ${activity.booking_code}</span>
                                    <span style="color: #888; font-size: 12px;">${time}</span>
                                </div>
                                <div style="font-size: 12px; color: #888;">
                                    Facility: ${activity.facility_id} ‚Ä¢ Status: ${activity.status}
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div style="padding: 8px 0; border-bottom: 1px solid #333;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>‚ö†Ô∏è ${activity.report_code}</span>
                                    <span style="color: #888; font-size: 12px;">${time}</span>
                                </div>
                                <div style="font-size: 12px; color: #888;">
                                    ${activity.jenis_insiden} ‚Ä¢ Status: ${activity.status}
                                </div>
                            </div>
                        `;
                    }
                });
            }
            
            container.innerHTML = html;
            
        } catch (error) {
            console.error('Activity load failed:', error);
        }
    }
    
    // SETUP REALTIME
    function setupRealtime() {
        if (!supabase) return;
        
        // Subscribe to changes
        supabase
            .channel('dream-dashboard')
            .on('postgres_changes', 
                { event: '*', schema: 'public', table: 'dream_bookings' },
                () => loadDashboard()
            )
            .on('postgres_changes',
                { event: '*', schema: 'public', table: 'dream_k3_reports' },
                () => loadDashboard()
            )
            .subscribe();
    }
    
    // MODAL FUNCTIONS
    function openModal(modalId) {
        document.getElementById('modal' + modalId.charAt(0).toUpperCase() + modalId.slice(1))
            .style.display = 'block';
        
        if (modalId === 'booking') loadFacilities();
        if (modalId === 'notifications') loadNotificationsModal();
    }
    
    function closeModal(modalId) {
        document.getElementById('modal' + modalId.charAt(0).toUpperCase() + modalId.slice(1))
            .style.display = 'none';
    }
    
    // LOAD FACILITIES FOR BOOKING
    async function loadFacilities() {
        try {
            const { data } = await supabase
                .from('dream_facilities')
                .select('id, nama_fasilitas, kode_fasilitas')
                .eq('status', 'available');
            
            const select = document.getElementById('bookingFacility');
            select.innerHTML = '<option value="">Select facility...</option>';
            
            data.forEach(facility => {
                const option = document.createElement('option');
                option.value = facility.id;
                option.textContent = `${facility.nama_fasilitas} (${facility.kode_fasilitas})`;
                select.appendChild(option);
            });
            
            // Set default date/time
            const now = new Date();
            document.getElementById('bookingDate').value = now.toISOString().split('T')[0];
            document.getElementById('bookingTime').value = 
                `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
        } catch (error) {
            console.error('Facilities load failed:', error);
        }
    }
    
    // BOOKING FORM SUBMIT
    document.getElementById('bookingForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const facilityId = document.getElementById('bookingFacility').value;
        const purpose = document.getElementById('bookingPurpose').value;
        const date = document.getElementById('bookingDate').value;
        const time = document.getElementById('bookingTime').value;
        const duration = parseInt(document.getElementById('bookingDuration').value);
        
        if (!facilityId || !purpose) {
            alert('Please fill all required fields');
            return;
        }
        
        // Calculate end time
        const [hours, minutes] = time.split(':').map(Number);
        const endTime = new Date();
        endTime.setHours(hours + duration, minutes);
        const endTimeStr = `${String(endTime.getHours()).padStart(2, '0')}:${String(endTime.getMinutes()).padStart(2, '0')}`;
        
        const bookingData = {
            user_id: currentUser.id,
            facility_id: facilityId,
            tujuan_penggunaan: purpose,
            tanggal_mulai: date,
            tanggal_selesai: date,
            waktu_mulai: time,
            waktu_selesai: endTimeStr,
            peserta_count: 1,
            status: 'pending'
        };
        
        try {
            const { error } = await supabase
                .from('dream_bookings')
                .insert([bookingData]);
            
            if (error) throw error;
            
            alert('‚úÖ Booking submitted successfully!');
            
            // Send WhatsApp notification
            sendWA(`üìÖ NEW BOOKING
User: ${currentUser.nama_lengkap}
Purpose: ${purpose}
Date: ${date}
Time: ${time} - ${endTimeStr}
Status: Pending approval`);
            
            closeModal('booking');
            document.getElementById('bookingForm').reset();
            await loadDashboard();
            
        } catch (error) {
            console.error('Booking failed:', error);
            alert('‚ùå Booking failed: ' + error.message);
        }
    });
    
    // K3 FORM SUBMIT
    document.getElementById('k3Form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const type = document.getElementById('k3Type').value;
        const severity = document.getElementById('k3Severity').value;
        const location = document.getElementById('k3Location').value;
        const description = document.getElementById('k3Description').value;
        
        if (!type || !location || !description) {
            alert('Please fill all required fields');
            return;
        }
        
        const k3Data = {
            user_id: currentUser.id,
            jenis_insiden: type,
            tingkat_keparahan: severity,
            lokasi: location,
            divisi: currentUser.divisi,
            deskripsi: description,
            status: 'dilaporkan',
            tanggal_insiden: new Date().toISOString().split('T')[0],
            waktu_insiden: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
        };
        
        try {
            const { error } = await supabase
                .from('dream_k3_reports')
                .insert([k3Data]);
            
            if (error) throw error;
            
            alert('‚úÖ K3 Report submitted!');
            
            // Send urgent WhatsApp for critical/high severity
            if (severity === 'kritis' || severity === 'tinggi') {
                sendWA(`üö® URGENT K3 REPORT
Type: ${type}
Severity: ${severity}
Location: ${location}
Description: ${description.substring(0, 100)}...
Reported by: ${currentUser.nama_lengkap}
ACTION REQUIRED IMMEDIATELY!`);
            }
            
            closeModal('k3');
            document.getElementById('k3Form').reset();
            await loadDashboard();
            
        } catch (error) {
            console.error('K3 report failed:', error);
            alert('‚ùå Report failed: ' + error.message);
        }
    });
    
    // LOAD NOTIFICATIONS MODAL
    async function loadNotificationsModal() {
        try {
            const { data } = await supabase
                .from('dream_notifications')
                .select('*')
                .eq('is_read', false)
                .order('created_at', { ascending: false })
                .limit(20);
            
            const modal = document.getElementById('modalNotifications');
            if (!modal) {
                // Create notifications modal
                const modalHTML = `
                    <div class="modal" id="modalNotifications">
                        <div class="modal-content">
                            <div class="modal-header">
                                <div class="modal-title">üîî Notifications</div>
                                <button class="modal-close" onclick="closeModal('notifications')">√ó</button>
                            </div>
                            <div id="notificationsList" style="max-height: 400px; overflow-y: auto;">
                                ${data && data.length > 0 ? 
                                    data.map(n => `
                                        <div class="notification unread">
                                            <strong>${n.title}</strong>
                                            <div style="font-size: 14px; color: #888; margin-top: 5px;">${n.message}</div>
                                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                                ${new Date(n.created_at).toLocaleString('id-ID')}
                                            </div>
                                        </div>
                                    `).join('') :
                                    '<div style="text-align: center; color: #888; padding: 20px;">No notifications</div>'
                                }
                            </div>
                            <button class="btn" onclick="markAllNotificationsRead()" style="width: 100%; margin-top: 15px;">
                                ‚úÖ Mark All as Read
                            </button>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }
            
        } catch (error) {
            console.error('Notifications load failed:', error);
        }
    }
    
    // MARK ALL NOTIFICATIONS READ
    async function markAllNotificationsRead() {
        try {
            const { error } = await supabase
                .from('dream_notifications')
                .update({ is_read: true })
                .eq('is_read', false);
            
            if (error) throw error;
            
            alert('‚úÖ All notifications marked as read');
            closeModal('notifications');
            await loadDashboard();
            
        } catch (error) {
            console.error('Mark read failed:', error);
        }
    }
    
    // ADMIN PANEL
    async function openAdmin() {
        const password = prompt('Admin Password:');
        if (password !== CONFIG.ADMIN_PASS) {
            alert('‚ùå Incorrect password');
            return;
        }
        
        try {
            // Load admin data
            const [bookings, k3, users] = await Promise.all([
                supabase.from('dream_bookings').select('*').order('created_at', { ascending: false }).limit(50),
                supabase.from('dream_k3_reports').select('*').order('created_at', { ascending: false }).limit(50),
                supabase.from('dream_users').select('*')
            ]);
            
            // Show admin panel
            showAdminPanel({
                bookings: bookings.data || [],
                k3: k3.data || [],
                users: users.data || []
            });
            
        } catch (error) {
            console.error('Admin panel failed:', error);
            alert('‚ùå Failed to load admin data');
        }
    }
    
    // SHOW ADMIN PANEL
    function showAdminPanel(data) {
        const adminHTML = `
            <div class="modal" id="modalAdmin" style="display: block;">
                <div class="modal-content" style="max-width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <div class="modal-title">üîê Admin Dashboard</div>
                        <button class="modal-close" onclick="closeModal('admin')">√ó</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-number">${data.users.length}</div>
                            <div class="stat-label">Users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.bookings.length}</div>
                            <div class="stat-label">Bookings</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.k3.length}</div>
                            <div class="stat-label">K3 Reports</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent); margin-bottom: 10px;">Quick Actions</h3>
                        <div class="btn-grid">
                            <button class="btn" onclick="exportData()">
                                üíæ Export Data
                            </button>
                            <button class="btn btn-warning" onclick="showPendingApprovals()">
                                ‚è≥ Pending Approvals (${data.bookings.filter(b => b.status === 'pending').length})
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="color: var(--accent); margin-bottom: 10px;">Recent Bookings</h3>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${data.bookings.slice(0, 10).map(b => `
                                <div style="padding: 8px; border-bottom: 1px solid #333; font-size: 14px;">
                                    <strong>${b.booking_code}</strong>
                                    <div style="color: #888; font-size: 12px;">
                                        ${b.tanggal_mulai} ‚Ä¢ ${b.status}
                                        ${b.status === 'pending' ? 
                                            `<button onclick="approveBooking(${b.id})" style="background: #0A0; color: white; border: none; padding: 2px 8px; border-radius: 4px; margin-left: 10px; font-size: 12px;">Approve</button>` : 
                                            ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', adminHTML);
    }
    
    // APPROVE BOOKING
    async function approveBooking(bookingId) {
        if (!confirm('Approve this booking?')) return;
        
        try {
            const { error } = await supabase
                .from('dream_bookings')
                .update({ status: 'approved' })
                .eq('id', bookingId);
            
            if (error) throw error;
            
            alert('‚úÖ Booking approved!');
            closeModal('admin');
            await openAdmin(); // Reload
            
        } catch (error) {
            console.error('Approval failed:', error);
            alert('‚ùå Approval failed');
        }
    }
    
    // EXPORT DATA
    async function exportData() {
        try {
            const [bookings, k3] = await Promise.all([
                supabase.from('dream_bookings').select('*'),
                supabase.from('dream_k3_reports').select('*')
            ]);
            
            const exportData = {
                exported_at: new Date().toISOString(),
                bookings: bookings.data || [],
                k3_reports: k3.data || []
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dream-os-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Data exported successfully!');
            
        } catch (error) {
            console.error('Export failed:', error);
            alert('‚ùå Export failed');
        }
    }
    
    // WHATSAPP FUNCTION
    function sendWA(message) {
        const phone = '628886183954';
        const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
        window.open(url, '_blank');
    }
    
    // UI HELPERS
    function showStatus(message) {
        document.getElementById('connectionStatus').textContent = message;
    }
    
    function loadOfflineData() {
        // Fallback for offline
        updateStatsUI({ bookings: 0, k3: 0, facilities: 0, notifications: 0 });
    }
    
    // INIT ON LOAD
    document.addEventListener('DOMContentLoaded', function() {
        initApp();
        
        // Handle online/offline
        window.addEventListener('online', initApp);
        window.addEventListener('offline', () => {
            showStatus('‚ùå Offline Mode');
            loadOfflineData();
        });
    });
    
    // GLOBAL FUNCTIONS FOR MODALS
    window.closeModal = closeModal;
    </script>
</body>
</html>
